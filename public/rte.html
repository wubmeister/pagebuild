<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Pagebuild</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Roboto:400,500,700" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="lib/pagebuild/css/pagebuild.css" />

    <style>
    body {
        margin: 15px;
    }
    .rte {
        background: #ebebeb;
        margin-top: 50px;
        line-height: 1.25;
        min-height: 1.25em;
    }
    </style>
</head>
<body>

    <div class="_pb_toolbar" style="left: 15px; top: 15px;"></div>

    <div class="rte" contenteditable="true"></div>

    <script>
        var rte = document.querySelector('.rte'),
            selection;

        /**
         * Safari/Firefox/Chrome/IE 10-11/Edge: Range
         */
        function saveSelection() {
            if (window.getSelection) {
                var sel = window.getSelection();
                if (sel.getRangeAt && sel.rangeCount) {
                    return sel.getRangeAt(0);
                }
            } else if (document.selection && document.selection.createRange) {
                return document.selection.createRange();
            }
            return null;
        }

        function restoreSelection(range) {
            if (range) {
                if (window.getSelection) {
                    var sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                } else if (document.selection && range.select) {
                    range.select();
                }
            }
        }

        var toolbarItems = {
            bold: {
                html: '<a class="_pb_button" data-action="bold"><i class="material-icons">format_bold</i></a>',
                runCommand: function() {
                    document.execCommand('bold');
                },
                updateState: function(node, style) {
                    if (style.fontWeight == 'bold') this.element.classList.add('active');
                    else this.element.classList.remove('active');
                }
            },
            italic: {
                html: '<a class="_pb_button" data-action="italic"><i class="material-icons">format_italic</i></a>',
                runCommand: function() {
                    document.execCommand('italic');
                },
                updateState: function(node, style) {
                    if (style.fontStyle == 'italic') this.element.classList.add('active');
                    else this.element.classList.remove('active');
                }
            },
            underline: {
                html: '<a class="_pb_button" data-action="underline"><i class="material-icons">format_underline</i></a>',
                runCommand: function() {
                    document.execCommand('underline');
                },
                updateState: function(node, style) {
                    if (style.textDecoration == 'underline') this.element.classList.add('active');
                    else this.element.classList.remove('active');
                }
            },
            divider1: {
                html: '<span class="_pb_divider"></span>',
                updateState: function(node, style) {}
            },
            left: {
                html: '<a class="_pb_button" data-action="left"><i class="material-icons">format_align_left</i></a>',
                runCommand: function() {
                    document.execCommand('justifyLeft');
                },
                updateState: function(node, style) {
                    if (style.textAlign == 'left') this.element.classList.add('active');
                    else this.element.classList.remove('active');
                }
            },
            center: {
                html: '<a class="_pb_button" data-action="center"><i class="material-icons">format_align_center</i></a>',
                runCommand: function() {
                    document.execCommand('justifyCenter');
                },
                updateState: function(node, style) {
                    if (style.textAlign == 'center') this.element.classList.add('active');
                    else this.element.classList.remove('active');
                }
            },
            right: {
                html: '<a class="_pb_button" data-action="right"><i class="material-icons">format_align_right</i></a>',
                runCommand: function() {
                    document.execCommand('justifyRight');
                },
                updateState: function(node, style) {
                    if (style.textAlign == 'right') this.element.classList.add('active');
                    else this.element.classList.remove('active');
                }
            },
            justify: {
                html: '<a class="_pb_button" data-action="justify"><i class="material-icons">format_align_justify</i></a>',
                runCommand: function() {
                    document.execCommand('justifyFull');
                },
                updateState: function(node, style) {
                    if (style.textAlign == 'justify') this.element.classList.add('active');
                    else this.element.classList.remove('active');
                }
            }
        };

        (function(){
            var div = document.createElement('div'),
                toolbar = document.querySelector('._pb_toolbar'),
                hideTimeout = null;

            function hideToolbar() {
                if (hideTimeout) {
                    clearTimeout(hideTimeout);
                }
                hideTimeout = setTimeout(function(){
                    toolbar.classList.remove('_pb_visible');
                }, 200);
            }

            for (let key in toolbarItems) {
                div.innerHTML = toolbarItems[key].html;
                toolbarItems[key].element = div.firstElementChild;
                toolbar.appendChild(toolbarItems[key].element);
            }

            toolbar.addEventListener('mousedown', function(e){
                selection = saveSelection();
            });

            toolbar.addEventListener('click', function(e){
                var el = e.target;

                if (hideTimeout) {
                    clearTimeout(hideTimeout);
                    hideTimeout = null;
                }

                while (el && el != this && !el.hasAttribute('data-action')) {
                    el = el.parentElement;
                }

                if (el && el != this && el.tagName.toLowerCase() != 'select') {
                    var action = el.getAttribute('data-action');

                    rte.focus();
                    restoreSelection(selection);

                    toolbarItems[action].runCommand();
                }
            });

            rte.addEventListener('focus', function(){
                toolbar.classList.add('_pb_visible');
            });
            rte.addEventListener('blur', function(){
                hideToolbar();
            });
        })();

        document.addEventListener('selectionchange', function(){
            var range = saveSelection();
            var startNode = range.startContainer;
            if (startNode.nodeType != Node.ELEMENT_NODE) {
                startNode = startNode.parentElement;
            }
            var style = getComputedStyle(startNode);

            for (let key in toolbarItems) {
                toolbarItems[key].updateState(startNode, style);
            }
        });
    </script>

</body>
</html>
